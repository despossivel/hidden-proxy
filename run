#!/bin/bash
# ─── Decentralized Proxy — Tor onion-to-onion reverse proxy ───────
# Auto-detects the environment and runs the correct script.
#
# Usage:
#   ./run              # auto-detect (arm* → prod, x86 → dev)
#   ./run dev          # force dev mode
#   ./run prod         # force prod mode
#   REDIS=1 ./run      # with Redis

set -e

MODE="${1:-auto}"
ARCH=$(uname -m)

if [ "$MODE" = "auto" ]; then
  case "$ARCH" in
    aarch64|armv7l|armv6l) MODE="prod" ;;
    *)                     MODE="dev"  ;;
  esac
fi

echo "▶ selected mode: $MODE  (arch: $ARCH)"
echo ""

DIR="$(cd "$(dirname "$0")" && pwd)"

if [ "$MODE" = "prod" ]; then
  exec "$DIR/run-prod"
else
  exec "$DIR/run-dev"
fi